<!doctype html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
  <th:block th:replace="~{fragments/layout :: layout(~{::content})}">
    <th:block th:fragment="content">
      <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3 mb-3">
        <div>
          <h4 class="mb-0">Painel</h4>
          <p class="text-muted mb-0">Acompanhe em tempo real o andamento das visitas.</p>
        </div>
        <div class="d-flex flex-column flex-sm-row align-items-sm-center gap-2">
          <span class="badge text-bg-secondary" sec:authentication="name">usuário</span>
          <div class="btn-group" th:if="${showAdminShortcuts}">
            <a class="btn btn-outline-success btn-sm" th:href="@{/admin/stores}">Gerenciar lojas</a>
            <a class="btn btn-outline-success btn-sm" th:href="@{/admin/visitas}">Agenda de visitas</a>
            <a class="btn btn-outline-success btn-sm" th:href="@{/admin/catalogos}">Catálogos</a>
          </div>
        </div>
      </div>

      <div class="row g-3">
        <div class="col-sm-6 col-lg-3">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <div class="small text-muted">Visitas hoje</div>
              <div class="fs-3 fw-semibold" th:text="${visitasHoje}">0</div>
            </div>
          </div>
        </div>
        <div class="col-sm-6 col-lg-3">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <div class="small text-muted">Usuários Loja ativos</div>
              <div class="fs-3 fw-semibold" th:text="${clientesAtivos}">0</div>
            </div>
          </div>
        </div>
      </div>

      <!-- BLOCO LOJA -->
      <div class="mt-4" th:if="${isStoreUser}">
        <div th:if="${needsStoreAssociation}">
          <div class="alert alert-info" role="alert">
            Você ainda não está associado a uma loja. Escolha uma opção abaixo para começar a acompanhar as visitas.
          </div>
        </div>

        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <h5 class="card-title">Minha loja</h5>
            <div th:if="${activeStore != null}">
              <p class="mb-1"><strong>Nome:</strong> <span th:text="${activeStore.name}">Loja</span></p>
              <p class="mb-0"><strong>CNPJ:</strong> <span th:text="${activeStore.cnpj} ?: '-'">-</span></p>
            </div>
            <div th:if="${activeStore == null}" class="text-muted">
              Nenhuma loja selecionada.
            </div>
            <form class="row g-2 mt-3" th:action="@{/loja/visitas/associar}" method="post">
              <div class="col-sm-8">
                <select class="form-select" name="storeId" required>
                  <option value="" disabled selected>Selecione uma loja</option>
                  <option th:each="store : ${availableStores}" th:value="${store.id}" th:text="${store.name}"></option>
                </select>
              </div>
              <div class="col-sm-4 text-sm-end">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <button class="btn btn-outline-success w-100" type="submit" th:text="${activeStore == null} ? 'Associar loja' : 'Alterar loja'">
                  Associar loja
                </button>
              </div>
            </form>
          </div>
        </div>

        <div class="alert alert-warning" role="alert" th:if="${hasOverduePending}">
          <strong>Atenção:</strong>
          Você possui
          <strong th:text="${overduePendingCount}">0</strong>
          visita(s) pendente(s) com data anterior a hoje. Atualize o status para manter o acompanhamento em dia.
        </div>

        <div class="card shadow-sm mb-4" th:if="${activeStore != null}">
          <div class="card-body">
            <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2 mb-3">
              <div>
                <h5 class="card-title mb-0">Visitas de hoje</h5>
                <small class="text-muted">Atualize rapidamente o status e registre comentários.</small>
              </div>
              <span class="badge text-bg-light" th:text="${#temporals.format(today, 'dd/MM/yyyy')}">10/06/2024</span>
            </div>
            <div th:if="${#lists.isEmpty(todayVisits)}" class="text-muted">Nenhuma visita agendada para hoje.</div>
            <div class="list-group" th:if="${!#lists.isEmpty(todayVisits)}">
              <div class="list-group-item" th:each="visit : ${todayVisits}">
                <div class="d-flex flex-column flex-md-row justify-content-between gap-2">
                  <div>
                    <h6 class="mb-1" th:text="${visit.modality != null ? visit.modality.label : 'Visita sem modalidade'}">Promotoria - Reposição</h6>
                    <div class="small text-muted">
                      Comprador:
                      <span th:text="${visit.buyer != null ? visit.buyer.name : '-'}">-</span>
                      &bull; Fornecedor:
                      <span th:text="${visit.supplier != null ? visit.supplier.name : '-'}">-</span>
                    </div>
                    <div class="small text-muted">
                      Segmento:
                      <span th:text="${visit.segment != null ? visit.segment.name : '-'}">-</span>
                    </div>
                    <div class="small text-muted">
                      Observação atual:
                      <span th:text="${visit.comment} ?: '-'">-</span>
                    </div>
                    <div class="small text-muted">
                      Nota registrada:
                      <span th:text="${visit.rating} ?: '-'}">-</span>
                    </div>
                    <div class="small text-muted">
                      Última atualização de status:
                      <span th:text="${visit.lastStatusUpdatedAt != null ? #temporals.format(visit.lastStatusUpdatedAt, 'dd/MM/yyyy HH:mm') : '-'}">-</span>
                      <span th:if="${visit.lastStatusUpdatedBy != null}">
                        por
                        <span th:text="${visit.lastStatusUpdatedBy.name}">Usuário</span>
                      </span>
                    </div>
                  </div>
                  <span class="badge align-self-start"
                        th:classappend="${visit.status != null} ? ' ' + visit.status.badgeClass : ' text-bg-secondary'"
                        th:text="${visit.status != null ? visit.status.label : 'Sem status'}">Pendente</span>
                </div>
                <div class="mt-3">
                  <div class="d-flex flex-wrap gap-2 mb-3">
                    <form th:action="@{'/loja/visitas/' + ${visit.id} + '/status'}" method="post">
                      <input type="hidden" name="status" value="COMPLETED">
                      <input type="hidden" name="target" value="home">
                      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                      <button type="submit" class="btn btn-outline-success btn-sm">Concluir</button>
                    </form>
                    <form th:action="@{'/loja/visitas/' + ${visit.id} + '/status'}" method="post">
                      <input type="hidden" name="status" value="NO_SHOW">
                      <input type="hidden" name="target" value="home">
                      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                      <button type="submit" class="btn btn-outline-danger btn-sm">Não realizada</button>
                    </form>
                    <form th:action="@{'/loja/visitas/' + ${visit.id} + '/status'}" method="post">
                      <input type="hidden" name="status" value="REOPENED">
                      <input type="hidden" name="target" value="home">
                      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                      <button type="submit" class="btn btn-outline-secondary btn-sm">Reabrir</button>
                    </form>
                  </div>
                  <form th:action="@{'/loja/visitas/' + ${visit.id} + '/status'}" method="post">
                    <div class="row g-2 align-items-end">
                      <div class="col-12 col-md-6">
                        <label class="form-label form-label-sm" th:for="${'comment-' + visit.id}">Observações</label>
                        <textarea class="form-control form-control-sm" rows="2" name="comment" th:id="${'comment-' + visit.id}" th:text="${visit.comment}"></textarea>
                      </div>
                      <div class="col-6 col-md-2">
                        <label class="form-label form-label-sm" th:for="${'rating-' + visit.id}">Nota (1-5)</label>
                        <input class="form-control form-control-sm" type="number" min="1" max="5" name="rating" th:id="${'rating-' + visit.id}" th:value="${visit.rating}">
                      </div>
                      <div class="col-6 col-md-2">
                        <label class="form-label form-label-sm" th:for="${'status-' + visit.id}">Status</label>
                        <select class="form-select form-select-sm" name="status" th:id="${'status-' + visit.id}" required>
                          <option th:each="status : ${T(com.inter.SistemaDeVisitas.entity.VisitStatus).values()}"
                                  th:value="${status.name()}"
                                  th:selected="${visit.status == status}"
                                  th:text="${status.label}"></option>
                        </select>
                      </div>
                      <div class="col-12 col-md-2 text-md-end">
                        <input type="hidden" name="target" value="home">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <button type="submit" class="btn btn-success btn-sm w-100">Salvar</button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card shadow-sm mb-4" th:if="${activeStore != null}">
          <div class="card-body">
            <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2 mb-3">
              <div>
                <h5 class="card-title mb-0">Agenda da semana</h5>
                <small class="text-muted">Semana selecionada: <span th:text="${#temporals.format(weekStart, 'dd/MM')} + ' - ' + ${#temporals.format(weekEnd, 'dd/MM')}">03/06 - 09/06</span></small>
              </div>
              <form class="d-flex flex-column flex-sm-row gap-2 align-items-sm-center" method="get" th:action="@{/home}">
                <input type="hidden" name="status" th:if="${param.status}" th:value="${param.status[0]}">
                <input type="hidden" name="storeId" th:if="${param.storeId}" th:value="${param.storeId[0]}">
                <input type="hidden" name="inicio" th:if="${param.inicio}" th:value="${param.inicio[0]}">
                <input type="hidden" name="fim" th:if="${param.fim}" th:value="${param.fim[0]}">
                <input type="hidden" name="dia" th:if="${param.dia}" th:value="${param.dia[0]}">
                <div class="input-group input-group-sm">
                  <label class="input-group-text" for="weekOffset">Semana</label>
                  <select class="form-select" id="weekOffset" name="semana">
                    <option th:each="offset : ${weekOptions}"
                            th:value="${offset}"
                            th:selected="${offset == weekOffset}"
                            th:text="${offset == 0 ? 'Semana atual (' + #temporals.format(weekStart, 'dd/MM') + ' - ' + #temporals.format(weekEnd, 'dd/MM') + ')' : #temporals.format(weekBase.plusWeeks(offset), 'dd/MM') + ' - ' + #temporals.format(weekBase.plusWeeks(offset).plusDays(6), 'dd/MM')}"></option>
                  </select>
                </div>
                <button class="btn btn-outline-success btn-sm" type="submit">Aplicar</button>
              </form>
            </div>
            <div class="table-responsive">
              <table class="table table-sm mb-0">
                <thead>
                  <tr>
                    <th>Data</th>
                    <th>Modalidade</th>
                    <th>Comprador</th>
                    <th>Fornecedor</th>
                    <th>Status</th>
                    <th>Informações comerciais</th>
                  </tr>
                </thead>
                <tbody>
                  <tr th:each="visit : ${storeVisits}">
                    <td th:text="${visit.scheduledDate != null ? #temporals.format(visit.scheduledDate, 'dd/MM/yyyy') : '-'}">10/06/2024</td>
                    <td th:text="${visit.modality != null ? visit.modality.label : '-'}">Promotoria - Reposição</td>
                    <td th:text="${visit.buyer != null ? visit.buyer.name : '-'}">-</td>
                    <td th:text="${visit.supplier != null ? visit.supplier.name : '-'}">-</td>
                    <td>
                      <span class="badge"
                            th:classappend="${visit.status != null} ? ' ' + visit.status.badgeClass : ' text-bg-secondary'"
                            th:text="${visit.status != null ? visit.status.label : 'Sem status'}">Pendente</span>
                    </td>
                    <td th:text="${visit.commercialInfo} ?: '-'">-</td>
                  </tr>
                  <tr th:if="${#lists.isEmpty(storeVisits)}">
                    <td colspan="6" class="text-center text-muted py-3">Nenhuma visita agendada nesta semana.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- BLOCO ADMIN -->
      <div class="mt-4" th:if="${isAdmin}">
        <div class="row g-3 mb-3">
          <div class="col-6 col-md-4 col-xl-2">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <div class="small text-muted">Visitas no período</div>
                <div class="fs-4 fw-semibold" th:text="${adminTotalVisits}">0</div>
              </div>
            </div>
          </div>
          <div class="col-6 col-md-4 col-xl-2">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <div class="small text-muted">Concluídas</div>
                <div class="fs-4 fw-semibold" th:text="${adminCompletedCount}">0</div>
              </div>
            </div>
          </div>
          <div class="col-6 col-md-4 col-xl-2">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <div class="small text-muted">Pendentes</div>
                <div class="fs-4 fw-semibold" th:text="${adminPendingCount}">0</div>
              </div>
            </div>
          </div>
          <div class="col-6 col-md-4 col-xl-2">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <div class="small text-muted">Não realizadas</div>
                <div class="fs-4 fw-semibold" th:text="${adminNoShowCount}">0</div>
              </div>
            </div>
          </div>
          <div class="col-6 col-md-4 col-xl-2">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <div class="small text-muted">Reabertas</div>
                <div class="fs-4 fw-semibold" th:text="${adminReopenedCount}">0</div>
              </div>
            </div>
          </div>
          <div class="col-6 col-md-4 col-xl-2">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <div class="small text-muted">Canceladas</div>
                <div class="fs-4 fw-semibold" th:text="${adminCancelledCount}">0</div>
              </div>
            </div>
          </div>
        </div>

        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-2 mb-3">
              <div>
                <h5 class="card-title mb-0">Filtrar painel</h5>
                <small class="text-muted">Selecione loja e período para atualizar os gráficos.</small>
              </div>
              <span class="badge text-bg-light" th:if="${adminSelectedStore != null}" th:text="${adminSelectedStore.name}">Loja</span>
            </div>
            <form method="get" class="row g-3 align-items-end">
              <div class="col-sm-6 col-lg-3">
                <label class="form-label" for="adminStore">Loja</label>
                <select class="form-select" id="adminStore" name="storeId">
                  <option value="">Todas</option>
                  <option th:each="store : ${storeSelection}"
                          th:value="${store.id}"
                          th:selected="${adminSelectedStore != null and store.id == adminSelectedStore.id}"
                          th:text="${store.name}"></option>
                </select>
              </div>
              <div class="col-sm-6 col-lg-2">
                <label class="form-label" for="adminStart">Início</label>
                <input class="form-control" type="date" id="adminStart" name="inicio" th:value="${adminStartDate}">
              </div>
              <div class="col-sm-6 col-lg-2">
                <label class="form-label" for="adminEnd">Fim</label>
                <input class="form-control" type="date" id="adminEnd" name="fim" th:value="${adminEndDate}">
              </div>
              <div class="col-sm-6 col-lg-2">
                <label class="form-label" for="adminStatus">Status</label>
                <select class="form-select" id="adminStatus" name="visitStatus">
                  <option value="">Todos</option>
                  <option th:each="status : ${statusOptions}"
                          th:value="${status.name()}"
                          th:selected="${adminSelectedStatus != null and status.name() == adminSelectedStatus}"
                          th:text="${status.label}"></option>
                </select>
              </div>
              <div class="col-sm-6 col-lg-2">
                <label class="form-label" for="adminDay">Dia da semana</label>
                <select class="form-select" id="adminDay" name="dia">
                  <option th:each="option : ${availableDays}"
                          th:value="${option}"
                          th:selected="${option == adminSelectedVisitDay}"
                          th:text="${option == 'todas' ? 'Todos' : #strings.capitalize(option)}"></option>
                </select>
              </div>
              <div class="col-sm-6 col-lg-1 text-lg-end">
                <button class="btn btn-success w-100" type="submit">Aplicar</button>
                <a class="btn btn-link btn-sm d-block mt-1" th:href="@{/home}">Limpar</a>
              </div>
            </form>
          </div>
        </div>

        <div class="row g-3 mb-4">
          <div class="col-12 col-lg-6">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <div class="d-flex flex-column flex-sm-row justify-content-between align-items-sm-center mb-3">
                  <div>
                    <h5 class="card-title mb-0">Distribuição de status</h5>
                    <small class="text-muted">Total de visitas: <span th:text="${adminTotalVisits}">0</span></small>
                  </div>
                  <span class="badge text-bg-light" th:if="${adminSelectedStore != null}" th:text="${adminSelectedStore.name}">Loja</span>
                </div>
                <div class="ratio ratio-4x3 mb-3">
                  <canvas id="adminStatusChart"></canvas>
                </div>
                <ul class="list-unstyled small mb-0">
                  <li th:each="status : ${T(com.inter.SistemaDeVisitas.entity.VisitStatus).values()}">
                    <span class="fw-semibold" th:text="${status.summaryLabel}">Status</span>:
                    <span th:text="${adminStatusSummary[status]} ?: 0">0</span>
                  </li>
                </ul>
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-6">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <div>
                  <h5 class="card-title mb-0">Evolução diária</h5>
                  <small class="text-muted">Período: <span th:text="${#temporals.format(adminStartDate, 'dd/MM')} + ' - ' + ${#temporals.format(adminEndDate, 'dd/MM')}">01/06 - 30/06</span></small>
                </div>
                <div class="ratio ratio-4x3">
                  <canvas id="adminDailyChart"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>

  <!-- Chart.js -->
  <script th:inline="javascript">
    const adminStatusLabels = /*[[${adminStatusLabels}]]*/ [];
    const adminStatusValues = /*[[${adminStatusValues}]]*/ [];
    const adminDailyLabels = /*[[${adminDailyLabels}]]*/ [];
    const adminDailyValues = /*[[${adminDailyValues}]]*/ [];

    const adminStatusCtx = document.getElementById('adminStatusChart');
    if (adminStatusCtx && adminStatusLabels.length > 0) {
      new Chart(adminStatusCtx, {
        type: 'doughnut',
        data: {
          labels: adminStatusLabels,
          datasets: [{
            data: adminStatusValues,
            backgroundColor: ['#2e7d32', '#ffc107', '#dc3545', '#0dcaf0', '#6c757d']
          }]
        },
        options: {
          plugins: { legend: { position: 'bottom' } }
        }
      });
    }

    const adminDailyCtx = document.getElementById('adminDailyChart');
    if (adminDailyCtx && adminDailyLabels.length > 0) {
      new Chart(adminDailyCtx, {
        type: 'line',
        data: {
          labels: adminDailyLabels,
          datasets: [{
            label: 'Visitas por dia',
            data: adminDailyValues,
            borderColor: '#2e7d32',
            backgroundColor: 'rgba(46,125,50,0.2)',
            tension: 0.35,
            fill: true,
            pointBackgroundColor: '#1b5e20'
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
              ticks: { precision: 0 }
            }
          },
          plugins: {
            legend: { display: false }
          }
        }
      });
    }
  </script>
</html>
