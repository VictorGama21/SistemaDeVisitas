<!doctype html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
  <th:block th:replace="~{fragments/layout :: layout(~{::content})}">

    <th:block th:fragment="content">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <h4 class="mb-0">Painel</h4>
        <span class="badge text-bg-secondary" sec:authentication="name">user</span>
      </div>

      <div class="row g-3">
        <div class="col-sm-6 col-lg-3">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="small text-muted">Visitas hoje</div>
              <div class="fs-3 fw-semibold" th:text="${visitasHoje}">0</div>
            </div>
          </div>
        </div>
        <div class="col-sm-6 col-lg-3">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="small text-muted">Usuario Loja ativos</div>
              <div class="fs-3 fw-semibold" th:text="${clientesAtivos}">0</div>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-4" th:if="${isStoreUser}">
        <div th:if="${needsStoreAssociation}">
          <div class="alert alert-info" role="alert">
            Você ainda não está associado a uma loja. Escolha uma opção abaixo para começar a acompanhar as visitas.
          </div>
        </div>

        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <h5 class="card-title">Minha loja</h5>
            <div th:if="${activeStore != null}">
              <p class="mb-1"><strong>Nome:</strong> <span th:text="${activeStore.name}">Loja</span></p>
              <p class="mb-0"><strong>CNPJ:</strong> <span th:text="${activeStore.cnpj} ?: '-'">-</span></p>
            </div>
            <div th:if="${activeStore == null}" class="text-muted">
              Nenhuma loja selecionada.
            </div>
            <form class="row g-2 mt-3" th:action="@{/loja/visitas/associar}" method="post">
              <div class="col-sm-8">
                <select class="form-select" name="storeId" required>
                  <option value="" disabled selected>Selecione uma loja</option>
                  <option th:each="store : ${availableStores}" th:value="${store.id}" th:text="${store.name}"></option>
                </select>
              </div>
              <div class="col-sm-4 text-sm-end">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <button class="btn btn-outline-success w-100" type="submit" th:text="${activeStore == null} ? 'Associar loja' : 'Alterar loja'">
                  Associar loja
                </button>
              </div>
            </form>
          </div>
        </div>

        <div class="card shadow-sm" th:if="${activeStore != null}">
          <div class="card-body">
            <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between mb-3 gap-2">
              <div>
                <h5 class="card-title mb-0">Visitas da semana</h5>
                <small class="text-muted" th:text="${#temporals.format(weekStart, 'dd/MM')} + ' a ' + #temporals.format(weekEnd, 'dd/MM')">10/06 a 16/06</small>
              </div>
              <form method="get" class="d-flex align-items-center gap-2">
                <input type="hidden" name="status" th:value="${param.status}">
                <select class="form-select form-select-sm" name="semana">
                  <option th:each="offset : ${weekOptions}"
                          th:value="${offset}"
                          th:selected="${offset == weekOffset}"
                          th:text="${offset == 0 ? 'Semana atual (' + #temporals.format(weekStart, 'dd/MM') + ' - ' + #temporals.format(weekEnd, 'dd/MM') + ')' : #temporals.format(weekBase.plusWeeks(offset), 'dd/MM') + ' - ' + #temporals.format(weekBase.plusWeeks(offset).plusDays(6), 'dd/MM')}"></option>
                </select>
                <button class="btn btn-outline-success btn-sm" type="submit">Aplicar</button>
              </form>
            </div>
            <div class="table-responsive">
              <table class="table table-sm mb-0">
                <thead>
                  <tr>
                    <th>Data</th>
                    <th>Modalidade</th>
                    <th>Comprador</th>
                    <th>Fornecedor</th>
                    <th>Status</th>
                    <th>Informações comerciais</th>
                  </tr>
                </thead>
                <tbody>
                  <tr th:each="visit : ${storeVisits}">
                    <td th:text="${visit.scheduledDate != null ? #temporals.format(visit.scheduledDate, 'dd/MM/yyyy') : '-'}">10/06/2024</td>
                    <td th:text="${visit.modality != null ? visit.modality.label : '-'}">Promotoria - Reposição</td>
                    <td th:text="${visit.buyer != null ? visit.buyer.name : '-'}">-</td>
                    <td th:text="${visit.supplier != null ? visit.supplier.name : '-'}">-</td>
                    <td><span class="badge text-bg-secondary" th:text="${visit.status}">PENDING</span></td>
                    <td th:text="${visit.commercialInfo} ?: '-'">-</td>
                  </tr>
                  <tr th:if="${#lists.isEmpty(storeVisits)}">
                    <td colspan="6" class="text-center text-muted py-3">Nenhuma visita agendada nesta semana.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-4" th:if="${isAdmin}">
        <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3 mb-3">
          <div>
            <h5 class="mb-0">Lojas monitoradas</h5>
            <p class="text-muted mb-0">Use os filtros para analisar a situação das unidades.</p>
          </div>
          <div class="btn-group">
            <a class="btn btn-outline-success btn-sm" th:href="@{/admin/stores}">Gerenciar lojas</a>
            <a class="btn btn-outline-success btn-sm" th:href="@{/admin/visitas}">Agendar visita</a>
          </div>
        </div>

        <p class="text-muted">Total de lojas ativas: <strong th:text="${totalStoresAtivas}">0</strong></p>

        <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3 mb-3">
          <div class="btn-group btn-group-sm" role="group" aria-label="Filtro de lojas">
            <a th:href="@{/home(status='ativos', dia=${rawDayFilter}, storeId=${adminSelectedStore != null ? adminSelectedStore.id : null}, inicio=${adminStartDate}, fim=${adminEndDate})}"
               class="btn btn-outline-success"
               th:classappend="${storeFilter == 'ativos'} ? ' active'">Ativas</a>
            <a th:href="@{/home(status='inativos', dia=${rawDayFilter}, storeId=${adminSelectedStore != null ? adminSelectedStore.id : null}, inicio=${adminStartDate}, fim=${adminEndDate})}"
               class="btn btn-outline-success"
               th:classappend="${storeFilter == 'inativos'} ? ' active'">Inativas</a>
            <a th:href="@{/home(status='todos', dia=${rawDayFilter}, storeId=${adminSelectedStore != null ? adminSelectedStore.id : null}, inicio=${adminStartDate}, fim=${adminEndDate})}"
               class="btn btn-outline-success"
               th:classappend="${storeFilter == 'todos'} ? ' active'">Todas</a>
          </div>
          <form method="get" class="d-flex align-items-center gap-2">
            <input type="hidden" name="status" th:value="${storeFilter}">
            <input type="hidden" name="storeId" th:value="${adminSelectedStore != null ? adminSelectedStore.id : null}">
            <input type="hidden" name="inicio" th:value="${adminStartDate}">
            <input type="hidden" name="fim" th:value="${adminEndDate}">
            <select class="form-select form-select-sm" name="dia">
              <option th:each="option : ${availableDays}" th:value="${option}" th:selected="${option == rawDayFilter}" th:text="${option == 'todas' ? 'Todos os dias' : #strings.capitalize(option)}"></option>
            </select>
            <button class="btn btn-outline-success btn-sm" type="submit">Filtrar dia</button>
          </form>
        </div>

        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <form method="get" class="row g-3 align-items-end">
              <input type="hidden" name="status" th:value="${storeFilter}">
              <input type="hidden" name="dia" th:value="${rawDayFilter}">
              <div class="col-md-4">
                <label class="form-label">Loja</label>
                <select class="form-select" name="storeId">
                  <option value="">Consolidado (todas)</option>
                  <option th:each="store : ${storeSelection}" th:value="${store.id}"
                          th:selected="${adminSelectedStore != null and store.id == adminSelectedStore.id}"
                          th:text="${store.name}"></option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Início</label>
                <input type="date" class="form-control" name="inicio" th:value="${adminStartDate}">
              </div>
              <div class="col-md-3">
                <label class="form-label">Fim</label>
                <input type="date" class="form-control" name="fim" th:value="${adminEndDate}">
              </div>
              <div class="col-md-2 text-md-end">
                <button class="btn btn-success w-100" type="submit">Aplicar</button>
              </div>
            </form>
          </div>
        </div>

        <div class="row g-3 mb-4">
          <div class="col-sm-6 col-xl-3">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <div class="small text-muted">Visitas no período</div>
                <div class="fs-3 fw-semibold" th:text="${adminTotalVisits}">0</div>
                <div class="text-muted small">Período: <span th:text="${#temporals.format(adminStartDate, 'dd/MM')} + ' a ' + #temporals.format(adminEndDate, 'dd/MM')}">01/01 a 31/01</span></div>
              </div>
            </div>
          </div>
          <div class="col-sm-6 col-xl-3">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <div class="small text-muted">Concluídas</div>
                <div class="fs-3 fw-semibold" th:text="${adminCompletedCount}">0</div>
                <div class="text-muted small">Reabertas: <span th:text="${adminReopenedCount}">0</span></div>
              </div>
            </div>
          </div>
          <div class="col-sm-6 col-xl-3">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <div class="small text-muted">Pendentes</div>
                <div class="fs-3 fw-semibold" th:text="${adminPendingCount}">0</div>
              </div>
            </div>
          </div>
          <div class="col-sm-6 col-xl-3">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <div class="small text-muted">Não realizadas</div>
                <div class="fs-3 fw-semibold" th:text="${adminNoShowCount}">0</div>
              </div>
            </div>
          </div>
        </div>

        <div class="row g-3 mb-4">
          <div class="col-12 col-lg-6">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <h5 class="card-title">Resumo por status</h5>
                <canvas id="adminStatusChart" height="220"></canvas>
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-6">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <h5 class="card-title">Visitas por dia</h5>
                <canvas id="adminDailyChart" height="220"></canvas>
              </div>
            </div>
          </div>
        </div>

        <div class="table-responsive bg-white shadow-sm rounded mb-4">
          <table class="table mb-0 align-middle">
            <thead>
              <tr>
                <th>Nome</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <tr th:each="store : ${stores}">
                <td th:text="${store.name}">Loja XPTO</td>
                <td>
                  <span class="badge" th:classappend="${store.active} ? ' text-bg-success' : ' text-bg-secondary'"
                        th:text="${store.active} ? 'Ativa' : 'Inativa'">Ativa</span>
                </td>
              </tr>
              <tr th:if="${#lists.isEmpty(stores)}">
                <td colspan="2" class="text-center text-muted py-3">Nenhuma loja cadastrada.</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="card shadow-sm">
          <div class="card-body">
@@ -180,26 +271,81 @@
                    <th>Fornecedor</th>
                    <th>Comprador</th>
                  </tr>
                </thead>
                <tbody>
                  <tr th:each="visit : ${upcomingVisits}">
                    <td th:text="${#temporals.format(visit.scheduledDate, 'dd/MM/yyyy')}">10/06/2024</td>
                    <td>
                      <span class="badge text-bg-light me-1" th:each="store : ${visit.stores}" th:text="${store.name}"></span>
                    </td>
                    <td th:text="${visit.modality.label}">Promotoria - Reposição</td>
                    <td th:text="${visit.supplier != null ? visit.supplier.name : '-'}">-</td>
                    <td th:text="${visit.buyer != null ? visit.buyer.name : '-'}">-</td>
                  </tr>
                  <tr th:if="${#lists.isEmpty(upcomingVisits)}">
                    <td colspan="5" class="text-center text-muted py-3">Nenhuma visita encontrada para o filtro selecionado.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </th:block>
  </th:block>
  <script th:inline="javascript">
    const adminStatusLabels = /*[[${adminStatusLabels}]]*/ [];
    const adminStatusValues = /*[[${adminStatusValues}]]*/ [];
    const adminDailyLabels = /*[[${adminDailyLabels}]]*/ [];
    const adminDailyValues = /*[[${adminDailyValues}]]*/ [];

    const adminStatusCtx = document.getElementById('adminStatusChart');
    if (adminStatusCtx && adminStatusLabels.length > 0) {
      new Chart(adminStatusCtx, {
        type: 'doughnut',
        data: {
          labels: adminStatusLabels,
          datasets: [{
            data: adminStatusValues,
            backgroundColor: ['#2e7d32', '#ffc107', '#dc3545', '#0dcaf0']
          }]
        },
        options: {
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }

    const adminDailyCtx = document.getElementById('adminDailyChart');
    if (adminDailyCtx && adminDailyLabels.length > 0) {
      new Chart(adminDailyCtx, {
        type: 'line',
        data: {
          labels: adminDailyLabels,
          datasets: [{
            label: 'Visitas',
            data: adminDailyValues,
            borderColor: '#2e7d32',
            backgroundColor: 'rgba(46, 125, 50, 0.2)',
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0
              }
            }
          }
        }
      });
    }
  </script>
</html>
