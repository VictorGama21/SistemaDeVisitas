<!-- src/main/resources/templates/home.html -->
<!doctype html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
  <!-- Chama o layout e injeta o fragmento "content" desta página -->
  <th:block th:replace="~{fragments/layout :: layout(~{::content})}">

    <!-- Este é o fragmento que será injetado dentro do layout -->
    <th:block th:fragment="content">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <h4 class="mb-0">Painel</h4>
        <span class="badge text-bg-secondary" sec:authentication="name">user</span>
      </div>

      <div class="row g-3">
        <div class="col-sm-6 col-lg-3">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="small text-muted">Visitas hoje</div>
              <div class="fs-3 fw-semibold" th:text="${visitasHoje}">0</div>
            </div>
          </div>
        </div>
        <div class="col-sm-6 col-lg-3">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="small text-muted">Clientes ativos</div>
              <div class="fs-3 fw-semibold" th:text="${clientesAtivos}">0</div>
            </div>
          </div>
        </div>
        <!-- cards extras -->
      </div>

      <div class="mt-4" th:if="${isStoreUser}">
        <div th:if="${needsStoreAssociation}">
          <div class="alert alert-info" role="alert">
            Você ainda não está associado a uma loja. Escolha uma opção abaixo para começar a acompanhar as visitas.
          </div>
        </div>

        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <h5 class="card-title">Minha loja</h5>
            <div th:if="${activeStore != null}">
              <p class="mb-1"><strong>Nome:</strong> <span th:text="${activeStore.name}">Loja</span></p>
              <p class="mb-0"><strong>CNPJ:</strong> <span th:text="${activeStore.cnpj} ?: '-'">-</span></p>
            </div>
            <div th:if="${activeStore == null}" class="text-muted">
              Nenhuma loja selecionada.
            </div>
            <form class="row g-2 mt-3" th:action="@{/loja/visitas/associar}" method="post">
              <div class="col-sm-8">
                <select class="form-select" name="storeId" required>
                  <option value="" disabled selected>Selecione uma loja</option>
                  <option th:each="store : ${availableStores}" th:value="${store.id}" th:text="${store.name}"></option>
                </select>
              </div>
              <div class="col-sm-4 text-sm-end">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <button class="btn btn-outline-success w-100" type="submit" th:text="${activeStore == null} ? 'Associar loja' : 'Alterar loja'">
                  Associar loja
                </button>
              </div>
            </form>
          </div>
        </div>

        <div class="card shadow-sm" th:if="${activeStore != null}">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="card-title mb-0">Próximas visitas</h5>
              <a class="btn btn-sm btn-outline-secondary" th:href="@{/loja/visitas}">Ver todas</a>
            </div>
            <div class="table-responsive">
              <table class="table table-sm mb-0">
                <thead>
                  <tr>
                    <th>Data</th>
                    <th>Status</th>
                    <th>Comentário</th>
                  </tr>
                </thead>
                <tbody>
                  <tr th:each="visit : ${storeVisits}">
                    <td th:text="${#temporals.format(visit.scheduledAt, 'dd/MM/yyyy HH:mm')}">10/06/2024 10:00</td>
                    <td><span class="badge text-bg-secondary" th:text="${visit.status}">PENDING</span></td>
                    <td th:text="${visit.comment} ?: '-'">-</td>
                  </tr>
                  <tr th:if="${#lists.isEmpty(storeVisits)}">
                    <td colspan="3" class="text-center text-muted py-3">Nenhuma visita agendada.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-4" th:if="${isAdmin}">
        <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3 mb-3">
          <div>
            <h5 class="mb-0">Lojas monitoradas</h5>
            <p class="text-muted mb-0">Use os filtros para analisar a situação das unidades.</p>
          </div>
          <div class="btn-group">
            <a class="btn btn-outline-success btn-sm" th:href="@{/admin/stores}">Gerenciar lojas</a>
            <a class="btn btn-outline-success btn-sm" th:href="@{/admin/visitas}">Agendar visita</a>
          </div>
        </div>

        <p class="text-muted">Total de lojas ativas: <strong th:text="${totalStoresAtivas}">0</strong></p>

        <div class="btn-group btn-group-sm mb-3" role="group" aria-label="Filtro de lojas">
          <a th:href="@{/home(status='ativos')}" class="btn btn-outline-success"
             th:classappend="${storeFilter == 'ativos'} ? ' active'">Ativas</a>
          <a th:href="@{/home(status='inativos')}" class="btn btn-outline-success"
             th:classappend="${storeFilter == 'inativos'} ? ' active'">Inativas</a>
          <a th:href="@{/home(status='todos')}" class="btn btn-outline-success"
             th:classappend="${storeFilter == 'todos'} ? ' active'">Todas</a>
        </div>

        <div class="table-responsive bg-white shadow-sm rounded">
          <table class="table mb-0 align-middle">
            <thead>
              <tr>
                <th>Nome</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <tr th:each="store : ${stores}">
                <td th:text="${store.name}">Loja XPTO</td>
                <td>
                  <span class="badge" th:classappend="${store.active} ? ' text-bg-success' : ' text-bg-secondary'"
                        th:text="${store.active} ? 'Ativa' : 'Inativa'">Ativa</span>
                </td>
              </tr>
              <tr th:if="${#lists.isEmpty(stores)}">
                <td colspan="2" class="text-center text-muted py-3">Nenhuma loja cadastrada.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </th:block>
  </th:block>
</html>
