<!doctype html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
  <th:block th:replace="~{fragments/layout :: layout(~{::content})}">
    <th:block th:fragment="content">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <div>
          <h4 class="mb-0">Minhas visitas</h4>
          <p class="text-muted mb-0">Acompanhe a agenda da loja associada ao seu perfil, filtre por status e registre feedbacks.</p>
        </div>
      </div>

      <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
      <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>

      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <h5 class="card-title">Loja associada</h5>
          <div th:if="${activeStore != null}">
            <p class="mb-1"><strong>Nome:</strong> <span th:text="${activeStore.name}">Loja</span></p>
            <p class="mb-0"><strong>CNPJ:</strong> <span th:text="${activeStore.cnpj} ?: '-'">-</span></p>
          </div>
          <div th:if="${activeStore == null}" class="alert alert-info mb-3">
            Você ainda não está associado a nenhuma loja. Escolha uma abaixo para visualizar os dados.
          </div>
          <form class="row g-2" th:action="@{/loja/visitas/associar}" method="post">
            <div class="col-sm-8">
              <select class="form-select" name="storeId" required>
                <option value="" disabled selected>Selecione uma loja</option>
                <option th:each="store : ${stores}" th:value="${store.id}" th:text="${store.name}"></option>
              </select>
            </div>
            <div class="col-sm-4 text-sm-end">
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
              <button class="btn btn-outline-success w-100" type="submit" th:text="${activeStore == null} ? 'Associar loja' : 'Alterar loja'">
                Associar loja
              </button>
            </div>
          </form>
        </div>
      </div>

      <div th:if="${activeStore != null}">
        <div class="row g-3 mb-3">
          <div class="col-sm-6 col-lg-3">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <div class="small text-muted">Visitas filtradas</div>
                <div class="fs-3 fw-semibold" th:text="${totalVisits}">0</div>
                <div class="text-muted small">Hoje: <span th:text="${todayCount}">0</span> &bull; Ontem: <span th:text="${yesterdayCount}">0</span></div>
              </div>
            </div>
          </div>
          <div class="col-sm-6 col-lg-3">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <div class="small text-muted">Concluídas</div>
                <div class="fs-3 fw-semibold" th:text="${completedCount}">0</div>
                <div class="text-muted small">Reabertas: <span th:text="${reopenedCount}">0</span></div>
              </div>
            </div>
          </div>
          <div class="col-sm-6 col-lg-3">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <div class="small text-muted">Pendentes</div>
                <div class="fs-3 fw-semibold" th:text="${pendingCount}">0</div>
                <div class="text-muted small">Não realizadas: <span th:text="${noShowCount}">0</span></div>
              </div>
            </div>
          </div>
          <div class="col-sm-6 col-lg-3">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <div class="small text-muted">Taxa de presença</div>
                <div class="fs-3 fw-semibold" th:text="${#numbers.formatDecimal(completionRate, 1, 1)} + '%'">0%</div>
                <div class="progress mt-2" style="height:6px;">
                  <div class="progress-bar bg-success" role="progressbar" th:style="'width:' + ${#numbers.formatDecimal(completionRate, 0, 0)} + '%'"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="alert alert-warning" role="alert" th:if="${hasOverduePending}">
          <strong>Atenção:</strong>
          Você possui
          <strong th:text="${overduePendingCount}">0</strong>
          visita(s) pendente(s) com data anterior a
          <strong th:text="${#temporals.format(today, 'dd/MM/yyyy')}">10/06/2024</strong>.
          Atualize os status para manter o acompanhamento em dia.
        </div>
        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-end gap-3 mb-3">
              <div>
                <h5 class="card-title mb-0">Filtros dinâmicos</h5>
                <p class="text-muted small mb-0">Combine status, período e dia da semana para encontrar visitas específicas.</p>
              </div>
            </div>
            <form method="get" class="row g-3 align-items-end">
              <div class="col-md-4">
                <label class="form-label">Período</label>
                <div class="input-group">
                  <input type="date" class="form-control" name="inicio" th:value="${startDate}">
                  <input type="date" class="form-control" name="fim" th:value="${endDate}">
                </div>
              </div>
              <div class="col-md-3">
                <label class="form-label">Dia da semana</label>
                <select class="form-select" name="dia">
                  <option th:each="option : ${dayOptions}"
                          th:value="${option}"
                          th:selected="${option == rawDayFilter}"
                          th:text="${option == 'todos' ? 'Todos' : #strings.capitalize(option)}"></option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Status</label>
                <div class="d-flex flex-wrap gap-2">
                  <div th:each="option : ${statusOptions}">
                    <input class="btn-check" type="checkbox" name="status" th:id="${'status-' + option.name()}" th:value="${option.name()}"
                           th:checked="${selectedStatuses.contains(option)}">
                    <label class="btn btn-outline-success btn-sm"
                           th:classappend="${selectedStatuses.contains(option)} ? ' active' : ''"
                           th:for="${'status-' + option.name()}"
                           th:text="${option == T(com.inter.SistemaDeVisitas.entity.VisitStatus).COMPLETED ? 'Concluída' :
                                      option == T(com.inter.SistemaDeVisitas.entity.VisitStatus).PENDING ? 'Pendente' :
                                      option == T(com.inter.SistemaDeVisitas.entity.VisitStatus).NO_SHOW ? 'Não realizada' : 'Reaberta'}"></label>
                  </div>
                </div>
              </div>
              <div class="col-md-2 text-md-end">
                <button type="submit" class="btn btn-success w-100">Aplicar filtros</button>
              </div>
              <div class="col-12 d-flex flex-wrap gap-2">
                <button type="submit" name="range" value="hoje" class="btn btn-outline-success btn-sm"
                        th:classappend="${range == 'hoje'} ? ' active'">Hoje</button>
                <button type="submit" name="range" value="ontem" class="btn btn-outline-success btn-sm"
                        th:classappend="${range == 'ontem'} ? ' active'">Ontem</button>
                <a class="btn btn-link btn-sm" th:href="@{/loja/visitas}">Limpar filtros</a>
              </div>
            </form>
          </div>
        </div>

        <div class="row g-3 mb-4">
          <div class="col-12 col-lg-6">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <h5 class="card-title">Distribuição por status</h5>
                <canvas id="statusChart" height="220"></canvas>
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-6">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <h5 class="card-title">Visitas por dia</h5>
                <canvas id="dailyChart" height="220"></canvas>
              </div>
            </div>
          </div>
        </div>

        <div class="card shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="card-title mb-0">Agenda detalhada</h5>
              <span class="badge" th:classappend="${activeStore.active} ? ' text-bg-success' : ' text-bg-secondary'" th:text="${activeStore.active} ? 'Loja ativa' : 'Loja inativa'"></span>
            </div>
            <div class="table-responsive">
              <table class="table align-middle mb-0">
                <thead>
                  <tr>
                    <th>Data</th>
                    <th>Modalidade</th>
                    <th>Comprador</th>
                    <th>Fornecedor</th>
                    <th>Segmento</th>
                    <th>Status</th>
                    <th>Comercial</th>
                    <th>Feedback</th>
                    <th class="text-end">Ações</th>
                  </tr>
                </thead>
                <tbody>
                  <th:block th:each="visit : ${visits}">
                  <tr>
                    <td th:text="${visit.scheduledDate != null ? #temporals.format(visit.scheduledDate, 'dd/MM/yyyy') : '-'}">10/06/2024</td>
                    <td th:text="${visit.modality.label}">Promotoria - Reposição</td>
                    <td th:text="${visit.buyer != null ? visit.buyer.name : '-'}">-</td>
                    <td th:text="${visit.supplier != null ? visit.supplier.name : '-'}">-</td>
                    <td th:text="${visit.segment != null ? visit.segment.name : '-'}">-</td>
                    <td>
                      <span class="badge"
                            th:classappend="${visit.status == T(com.inter.SistemaDeVisitas.entity.VisitStatus).COMPLETED} ? ' text-bg-success' :
                                            (visit.status == T(com.inter.SistemaDeVisitas.entity.VisitStatus).PENDING ? ' text-bg-warning' :
                                            (visit.status == T(com.inter.SistemaDeVisitas.entity.VisitStatus).NO_SHOW ? ' text-bg-danger' : ' text-bg-info'))"
                            th:text="${visit.status == T(com.inter.SistemaDeVisitas.entity.VisitStatus).COMPLETED} ? 'Concluída' :
                                      (visit.status == T(com.inter.SistemaDeVisitas.entity.VisitStatus).PENDING ? 'Pendente' :
                                      (visit.status == T(com.inter.SistemaDeVisitas.entity.VisitStatus).NO_SHOW ? 'Não realizada' : 'Reaberta'))}"></span>
                    </td>
                    <td th:text="${visit.commercialInfo} ?: '-'">-</td>
                    <td>
                      <div class="small text-muted">Comentário</div>
                      <div th:text="${visit.comment} ?: '-'" class="mb-1">-</div>
                      <div class="small text-muted">Nota</div>
                      <div th:text="${visit.rating} ?: '-'">-</div>
                    </td>
                    <td class="text-end">
                      <div class="d-flex flex-column gap-1">
                        <form th:action="@{'/loja/visitas/' + ${visit.id} + '/status'}" method="post">
                          <input type="hidden" name="status" value="COMPLETED">
                          <input type="hidden" name="redirect" th:value="${currentQuery}">
                          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                          <button type="submit" class="btn btn-outline-success btn-sm">Concluir</button>
                        </form>
                        <form th:action="@{'/loja/visitas/' + ${visit.id} + '/status'}" method="post">
                          <input type="hidden" name="status" value="NO_SHOW">
                          <input type="hidden" name="redirect" th:value="${currentQuery}">
                          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                          <button type="submit" class="btn btn-outline-danger btn-sm">Não realizada</button>
                        </form>
                        <form th:action="@{'/loja/visitas/' + ${visit.id} + '/status'}" method="post">
                          <input type="hidden" name="status" value="REOPENED">
                          <input type="hidden" name="redirect" th:value="${currentQuery}">
                          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                          <button type="submit" class="btn btn-outline-secondary btn-sm">Reabrir</button>
                        </form>
                        <button class="btn btn-link btn-sm p-0" type="button" data-bs-toggle="collapse" th:data-bs-target="${'#feedback-' + visit.id}">
                          Editar feedback
                        </button>
                      </div>
                    </td>
                  </tr>
                  <tr class="collapse" th:id="${'feedback-' + visit.id}">
                    <td colspan="9">
                      <form class="row g-3 align-items-end" th:action="@{'/loja/visitas/' + ${visit.id} + '/status'}" method="post">
                        <div class="col-md-4">
                          <label class="form-label">Atualizar status</label>
                          <select class="form-select" name="status">
                            <option value="PENDING" th:selected="${visit.status == T(com.inter.SistemaDeVisitas.entity.VisitStatus).PENDING}">Pendente</option>
                            <option value="COMPLETED" th:selected="${visit.status == T(com.inter.SistemaDeVisitas.entity.VisitStatus).COMPLETED}">Concluída</option>
                            <option value="NO_SHOW" th:selected="${visit.status == T(com.inter.SistemaDeVisitas.entity.VisitStatus).NO_SHOW}">Não realizada</option>
                            <option value="REOPENED" th:selected="${visit.status == T(com.inter.SistemaDeVisitas.entity.VisitStatus).REOPENED}">Reaberta</option>
                          </select>
                        </div>
                        <div class="col-md-4">
                          <label class="form-label">Comentário</label>
                          <textarea class="form-control" name="comment" rows="2" th:text="${visit.comment}"></textarea>
                        </div>
                        <div class="col-md-2">
                          <label class="form-label">Nota (1 a 5)</label>
                          <input type="number" min="1" max="5" class="form-control" name="rating" th:value="${visit.rating}">
                        </div>
                        <div class="col-md-2 text-md-end">
                          <input type="hidden" name="redirect" th:value="${currentQuery}">
                          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                          <button type="submit" class="btn btn-success w-100">Salvar</button>
                        </div>
                      </form>
                    </td>
                  </tr>
                  </th:block>
                  <tr th:if="${#lists.isEmpty(visits)}">
                    <td colspan="9" class="text-center text-muted py-4">Nenhuma visita encontrada para os filtros selecionados.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </th:block>
  </th:block>

  <script th:inline="javascript">
    const statusLabels = /*[[${statusChartLabels}]]*/ [];
    const statusValues = /*[[${statusChartValues}]]*/ [];
    const dailyLabels = /*[[${dailyChartLabels}]]*/ [];
    const dailyValues = /*[[${dailyChartValues}]]*/ [];

    const statusCtx = document.getElementById('statusChart');
    if (statusCtx && statusLabels.length > 0) {
      new Chart(statusCtx, {
        type: 'doughnut',
        data: {
          labels: statusLabels,
          datasets: [{
            data: statusValues,
            backgroundColor: ['#2e7d32', '#ffc107', '#dc3545', '#0dcaf0']
          }]
        },
        options: {
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }

    const dailyCtx = document.getElementById('dailyChart');
    if (dailyCtx && dailyLabels.length > 0) {
      new Chart(dailyCtx, {
        type: 'line',
        data: {
          labels: dailyLabels,
          datasets: [{
            label: 'Visitas',
            data: dailyValues,
            borderColor: '#2e7d32',
            backgroundColor: 'rgba(46, 125, 50, 0.2)',
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0
              }
            }
          }
        }
      });
    }
  </script>
</html>
