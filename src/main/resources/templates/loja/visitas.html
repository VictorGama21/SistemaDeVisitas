<!doctype html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
  <th:block th:replace="~{fragments/layout :: layout(~{::content})}">
    <th:block th:fragment="content">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <div>
          <h4 class="mb-0">Minhas visitas</h4>
          <p class="text-muted mb-0">Acompanhe a agenda da loja associada ao seu perfil, filtre por status e registre feedbacks.</p>
        </div>
      </div>

      <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
      <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>

      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <h5 class="card-title">Loja associada</h5>
          <div th:if="${activeStore != null}">
            <p class="mb-1"><strong>Nome:</strong> <span th:text="${activeStore.name}">Loja</span></p>
            <p class="mb-0"><strong>CNPJ:</strong> <span th:text="${activeStore.cnpj} ?: '-'">-</span></p>
          </div>
          <div th:if="${activeStore == null}" class="alert alert-info mb-3">
            Você ainda não está associado a nenhuma loja. Escolha uma abaixo para visualizar os dados.
          </div>
          <form class="row g-2" th:action="@{/loja/visitas/associar}" method="post">
            <div class="col-sm-8">
              <select class="form-select" name="storeId" required>
                <option value="" disabled selected>Selecione uma loja</option>
                <option th:each="store : ${stores}" th:value="${store.id}" th:text="${store.name}"></option>
              </select>
            </div>
            <div class="col-sm-4 text-sm-end">
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
              <button class="btn btn-outline-success w-100" type="submit" th:text="${activeStore == null} ? 'Associar loja' : 'Alterar loja'">
                Associar loja
              </button>
            </div>
          </form>
        </div>
      </div>

      <div th:if="${activeStore != null}">
        <div class="row g-3 mb-3">
          <div class="col-sm-6 col-lg-3">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <div class="small text-muted">Visitas filtradas</div>
                <div class="fs-3 fw-semibold" th:text="${totalVisits}">0</div>
                <div class="text-muted small">Hoje: <span th:text="${todayCount}">0</span> &bull; Ontem: <span th:text="${yesterdayCount}">0</span></div>
              </div>
            </div>
          </div>
          <div class="col-sm-6 col-lg-3">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <div class="small text-muted">Concluídas</div>
                <div class="fs-3 fw-semibold" th:text="${completedCount}">0</div>
                <div class="text-muted small">Reabertas: <span th:text="${reopenedCount}">0</span></div>
                <div class="text-muted small">Canceladas: <span th:text="${cancelledCount}">0</span></div>
              </div>
            </div>
          </div>
          <div class="col-sm-6 col-lg-3">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <div class="small text-muted">Pendentes</div>
                <div class="fs-3 fw-semibold" th:text="${pendingCount}">0</div>
                <div class="text-muted small">Não realizadas: <span th:text="${noShowCount}">0</span></div>
              </div>
            </div>
          </div>
          <div class="col-sm-6 col-lg-3">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <div class="small text-muted">Taxa de presença</div>
                <div class="fs-3 fw-semibold" th:text="${#numbers.formatDecimal(completionRate, 1, 1)} + '%'">0%</div>
                <div class="progress mt-2" style="height:6px;">
                  <div class="progress-bar bg-success" role="progressbar" th:style="'width:' + ${#numbers.formatDecimal(completionRate, 0, 0)} + '%'"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="alert alert-warning" role="alert" th:if="${hasOverduePending}">
          <strong>Atenção:</strong>
          Você possui
          <strong th:text="${overduePendingCount}">0</strong>
          visita(s) pendente(s) com data anterior a
          <strong th:text="${#temporals.format(today, 'dd/MM/yyyy')}">10/06/2024</strong>.
          Atualize os status para manter o acompanhamento em dia.
        </div>
        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-end gap-3 mb-3">
              <div>
                <h5 class="card-title mb-0">Filtros dinâmicos</h5>
                <p class="text-muted small mb-0">Combine status, período e dia da semana para encontrar visitas específicas.</p>
              </div>
              <div class="d-flex flex-wrap gap-2">
                <button type="submit" form="visitsFilters" name="range" value="hoje" class="btn btn-outline-success btn-sm"
                        th:classappend="${range == 'hoje'} ? ' active'">Hoje</button>
                <button type="submit" form="visitsFilters" name="range" value="ontem" class="btn btn-outline-success btn-sm"
                        th:classappend="${range == 'ontem'} ? ' active'">Ontem</button>
                <a class="btn btn-link btn-sm" th:href="@{/loja/visitas}">Limpar filtros</a>
              </div>
            </div>
            <form id="visitsFilters" method="get" class="row g-3 align-items-end">
              <div class="col-12 col-lg-5">
                <label class="form-label">Período</label>
                <div class="input-group">
                  <input type="date" class="form-control" name="inicio" th:value="${startDate}">
                  <input type="date" class="form-control" name="fim" th:value="${endDate}">
                </div>
              </div>
              <div class="col-12 col-md-4 col-lg-3">
                <label class="form-label">Dia da semana</label>
                <select class="form-select" name="dia">
                  <option th:each="option : ${dayOptions}"
                          th:value="${option}"
                          th:selected="${option == rawDayFilter}"
                          th:text="${option == 'todos' ? 'Todos' : #strings.capitalize(option)}"></option>
                </select>
              </div>
              <div class="col-12 col-md-8 col-lg-3">
                <label class="form-label">Status</label>
                <div class="d-flex flex-wrap gap-2">
                  <div th:each="option : ${statusOptions}">
                    <input class="btn-check" type="checkbox" name="status" th:id="${'status-' + option.name()}" th:value="${option.name()}"
                           th:checked="${selectedStatuses.contains(option)}">
                    <label class="btn btn-outline-success btn-sm"
                           th:classappend="${selectedStatuses.contains(option)} ? ' active' : ''"
                           th:for="${'status-' + option.name()}"
                           th:text="${option.label}"></label>
                  </div>
                </div>
              </div>
              <div class="col-12 col-lg-1 text-lg-end">
                <button type="submit" class="btn btn-success w-100">Filtrar</button>
              </div>
            </form>
          </div>
        </div>

        <div class="row g-3 mb-4">
          <div class="col-12 col-lg-6">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <h5 class="card-title">Distribuição por status</h5>
                <canvas id="statusChart" height="220"></canvas>
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-6">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <h5 class="card-title">Visitas por dia</h5>
                <canvas id="dailyChart" height="220"></canvas>
              </div>
            </div>
          </div>
        </div>

        <div class="card shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
              <h5 class="card-title mb-0">Agenda detalhada</h5>
              <span class="badge" th:classappend="${activeStore.active} ? ' text-bg-success' : ' text-bg-secondary'" th:text="${activeStore.active} ? 'Loja ativa' : 'Loja inativa'"></span>
            </div>
            <div th:if="${#lists.isEmpty(visits)}" class="text-center text-muted py-4">
              Nenhuma visita encontrada para os filtros selecionados.
            </div>
            <div th:if="${!#lists.isEmpty(visits)}" class="d-flex flex-column gap-3">
              <div class="card border-0 shadow-sm" th:each="visit : ${visits}">
                <div class="card-body p-3 p-md-4">
                  <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-3">
                    <div>
                      <div class="d-flex flex-wrap align-items-center gap-2">
                        <h6 class="mb-0" th:text="${visit.scheduledDate != null ? #temporals.format(visit.scheduledDate, 'dd/MM/yyyy') : 'Sem data'}"></h6>
                        <span class="badge"
                              th:classappend="${visit.status != null} ? ' ' + visit.status.badgeClass : ' text-bg-secondary'"
                              th:text="${visit.status != null ? visit.status.label : 'Sem status'}"></span>
                      </div>
                      <div class="text-muted small" th:text="${visit.scheduledDate != null ? #temporals.format(visit.scheduledDate, 'EEEE', T(java.util.Locale).forLanguageTag('pt-BR')) : ''}"></div>
                    </div>
                    <div class="d-flex flex-wrap gap-2">
                      <form th:action="@{'/loja/visitas/' + ${visit.id} + '/status'}" method="post" class="d-inline">
                        <input type="hidden" name="status" value="COMPLETED">
                        <input type="hidden" name="redirect" th:value="${currentQuery}">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <button type="submit" class="btn btn-success btn-sm"
                                th:disabled="${visit.status == T(com.inter.SistemaDeVisitas.entity.VisitStatus).COMPLETED}">
                          Concluir
                        </button>
                      </form>
                      <form th:action="@{'/loja/visitas/' + ${visit.id} + '/status'}" method="post" class="d-inline">
                        <input type="hidden" name="status" value="NO_SHOW">
                        <input type="hidden" name="redirect" th:value="${currentQuery}">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <button type="submit" class="btn btn-outline-danger btn-sm"
                                th:disabled="${visit.status == T(com.inter.SistemaDeVisitas.entity.VisitStatus).NO_SHOW}">
                          Não compareceu
                        </button>
                      </form>
                      <form th:action="@{'/loja/visitas/' + ${visit.id} + '/status'}" method="post" class="d-inline">
                        <input type="hidden" name="status" value="REOPENED">
                        <input type="hidden" name="redirect" th:value="${currentQuery}">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <button type="submit" class="btn btn-outline-secondary btn-sm"
                                th:disabled="${visit.status == T(com.inter.SistemaDeVisitas.entity.VisitStatus).REOPENED}">
                          Reabrir visita
                        </button>
                      </form>
                      <button class="btn btn-link btn-sm" type="button" data-bs-toggle="collapse" th:data-bs-target="${'#feedback-' + visit.id}">
                        Feedback / Comentário
                      </button>
                    </div>
                  </div>

                  <div class="row g-3 mb-3">
                    <div class="col-12 col-md-6 col-lg-4">
                      <div class="text-muted small">Lojas</div>
                      <div>
                        <span class="badge text-bg-light me-1" th:each="store : ${visit.stores}" th:text="${store.name}"></span>
                      </div>
                    </div>
                    <div class="col-6 col-md-3 col-lg-2">
                      <div class="text-muted small">Modalidade</div>
                      <div th:text="${visit.modality != null ? visit.modality.label : '-'}">-</div>
                    </div>
                    <div class="col-6 col-md-3 col-lg-2">
                      <div class="text-muted small">Comprador</div>
                      <div th:text="${visit.buyer != null ? visit.buyer.name : '-'}">-</div>
                    </div>
                    <div class="col-6 col-md-3 col-lg-2">
                      <div class="text-muted small">Fornecedor</div>
                      <div th:text="${visit.supplier != null ? visit.supplier.name : '-'}">-</div>
                    </div>
                    <div class="col-6 col-md-3 col-lg-2">
                      <div class="text-muted small">Segmento</div>
                      <div th:text="${visit.segment != null ? visit.segment.name : '-'}">-</div>
                    </div>
                  </div>

                  <div class="row g-3">
                    <div class="col-12 col-md-6">
                      <div class="text-muted small">Informações comerciais</div>
                      <p class="mb-0" th:text="${visit.commercialInfo} ?: 'Nenhuma informação registrada.'"></p>
                    </div>
                    <div class="col-12 col-md-6">
                      <div class="text-muted small">Feedback registrado</div>
                      <p class="mb-1" th:text="${visit.comment} ?: 'Sem comentário.'"></p>
                      <div class="text-muted small">Nota</div>
                      <div class="fw-semibold" th:text="${visit.rating} ?: 'Sem avaliação'">-</div>
                      <div class="text-muted small mt-2">
                        Atualizado em
                        <span th:text="${visit.lastStatusUpdatedAt != null ? #temporals.format(visit.lastStatusUpdatedAt, 'dd/MM/yyyy HH:mm') : '-'}">-</span>
                        <span th:if="${visit.lastStatusUpdatedBy != null}">
                          por
                          <span th:text="${visit.lastStatusUpdatedBy.name}">Usuário</span>
                        </span>
                      </div>
                    </div>
                  </div>

                  <div class="collapse mt-3" th:id="${'feedback-' + visit.id}">
                    <div class="card card-body border-success-subtle">
                      <h6 class="mb-3">Atualizar feedback</h6>
                      <form th:action="@{'/loja/visitas/' + ${visit.id} + '/status'}" method="post" class="row g-3">
                        <div class="col-12 col-md-6">
                          <label class="form-label">Comentário</label>
                          <textarea class="form-control" name="comment" rows="3" th:text="${visit.comment}"></textarea>
                        </div>
                        <div class="col-6 col-md-3 col-lg-2">
                          <label class="form-label">Nota (1 a 5)</label>
                          <input type="number" class="form-control" name="rating" min="1" max="5" th:value="${visit.rating}">
                        </div>
                        <div class="col-6 col-md-3 col-lg-3">
                          <label class="form-label">Status da visita</label>
                          <select class="form-select" name="status">
                            <option th:each="option : ${statusOptions}"
                                    th:value="${option.name()}"
                                    th:selected="${option == visit.status}"
                                    th:text="${option.label}"></option>
                          </select>
                        </div>
                        <div class="col-12 d-flex justify-content-end gap-2">
                          <input type="hidden" name="redirect" th:value="${currentQuery}">
                          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                          <button type="submit" class="btn btn-success">Salvar feedback</button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </th:block>
  </th:block>

  <script th:inline="javascript">
    const statusLabels = /*[[${statusChartLabels}]]*/ [];
    const statusValues = /*[[${statusChartValues}]]*/ [];
    const dailyLabels = /*[[${dailyChartLabels}]]*/ [];
    const dailyValues = /*[[${dailyChartValues}]]*/ [];

    const statusCtx = document.getElementById('statusChart');
    if (statusCtx && statusLabels.length > 0) {
      new Chart(statusCtx, {
        type: 'doughnut',
        data: {
          labels: statusLabels,
          datasets: [{
            data: statusValues,
            backgroundColor: ['#2e7d32', '#ffc107', '#dc3545', '#0dcaf0', '#6c757d']
          }]
        },
        options: {
              scales: {
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0
              }
            }
          }
        }
      });
    }
  </script>
</html>
