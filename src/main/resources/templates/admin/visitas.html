<!doctype html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
  <th:block th:replace="~{fragments/layout :: layout(~{::content})}">
    <th:block th:fragment="content">
      <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between mb-3 gap-3">
        <div>
          <h4 class="mb-0">Agenda de visitas</h4>
          <p class="text-muted mb-0">Agende e acompanhe as visitas de todas as lojas.</p>
        </div>
        <div class="btn-group">
          <a class="btn btn-outline-success btn-sm" href="/admin/catalogos">Catálogos auxiliares</a>
        </div>
      </div>

      <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>
      <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
      <div th:if="${warningMessages}" class="alert alert-warning">
        <p class="mb-1 fw-semibold">Importação concluída com avisos:</p>
        <ul class="mb-0 ps-3">
          <li th:each="msg : ${warningMessages}" th:text="${msg}"></li>
        </ul>
      </div>

      <div class="row g-3 mb-4">
        <div class="col-12 col-lg-4">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <h5 class="card-title">Agendar nova visita</h5>
              <form th:action="@{/admin/visitas}" method="post" class="needs-validation" novalidate>
                <div class="mb-3">
                  <label for="visitStore" class="form-label">Lojas</label>
                  <select id="visitStore" name="storeIds" class="form-select" multiple required>
                    <option th:each="store : ${stores}" th:value="${store.id}" th:text="${store.name}"></option>
                  </select>
                  <div class="form-text">Selecione uma ou mais lojas (Ctrl + clique).</div>
                </div>
                <div class="mb-3">
                  <label for="visitDate" class="form-label">Data da visita</label>
                  <input type="date" id="visitDate" name="scheduledDate" class="form-control" required>
                </div>
                <div class="mb-3">
                  <label for="visitBuyer" class="form-label">Comprador responsável</label>
                  <input id="visitBuyer" name="buyerName" list="buyerOptions" class="form-control" placeholder="Comece a digitar...">
                  <datalist id="buyerOptions">
                    <option th:each="buyer : ${buyers}" th:value="${buyer.name}"></option>
                  </datalist>
                </div>
                <div class="mb-3">
                  <label for="visitSupplier" class="form-label">Fornecedor</label>
                  <input id="visitSupplier" name="supplierName" list="supplierOptions" class="form-control" placeholder="Comece a digitar...">
                  <datalist id="supplierOptions">
                    <option th:each="supplier : ${suppliers}" th:value="${supplier.name}"></option>
                  </datalist>
                </div>
                <div class="mb-3">
                  <label for="visitSegment" class="form-label">Segmento</label>
                  <input id="visitSegment" name="segmentName" list="segmentOptions" class="form-control" placeholder="Digite para pesquisar">
                  <datalist id="segmentOptions">
                    <option th:each="segment : ${segments}" th:value="${segment.name}"></option>
                  </datalist>
                </div>
                <div class="mb-3">
                  <label for="visitModality" class="form-label">Modalidade</label>
                  <select id="visitModality" name="modality" class="form-select">
                    <option th:each="modality : ${modalities}" th:value="${modality.name()}" th:text="${modality.label}"></option>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="visitCommercialInfo" class="form-label">Informações comerciais</label>
                  <textarea id="visitCommercialInfo" name="commercialInfo" class="form-control" rows="3" placeholder="Troca, devolução, ações combinadas..."></textarea>
                </div>
                <div class="mb-3">
                  <label for="visitComment" class="form-label">Observações internas</label>
                  <textarea id="visitComment" name="comment" class="form-control" rows="2"></textarea>
                </div>
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <button type="submit" class="btn btn-success w-100">Agendar</button>
              </form>
            </div>
          </div>
        </div>
        <div class="col-12 col-lg-8">
          <div class="card shadow-sm mb-3">
            <div class="card-body">
              <h5 class="card-title">Importar visitas em lote</h5>
              <p class="text-muted small">Envie um arquivo CSV com as colunas Data (dd/MM/aaaa); Lojas (separadas por "|"); Comprador; Fornecedor; Segmento; Modalidade; Informações comerciais; Observações.</p>
              <div class="d-flex flex-column flex-md-row gap-2 mb-3">
                <a class="btn btn-outline-secondary btn-sm" href="/modelos/visitas.csv" download>Baixar modelo CSV</a>
              </div>
              <form th:action="@{/admin/visitas/importar}" method="post" enctype="multipart/form-data" class="row g-2 align-items-center">
                <div class="col-12 col-md-8">
                  <input type="file" class="form-control" name="file" accept=".csv,.txt" required>
                </div>
                <div class="col-12 col-md-4 text-md-end">
                  <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                  <button type="submit" class="btn btn-outline-success w-100">Importar</button>
                </div>
              </form>
            </div>
          </div>

          <div class="card shadow-sm">
            <div class="card-body">
              <form method="get" class="row g-3 align-items-end mb-3">
                <input type="hidden" name="page" value="0">
                <div class="col-12 col-lg-3">
                  <label for="filterStore" class="form-label">Filtrar por loja</label>
                  <select id="filterStore" name="storeId" class="form-select">
                    <option value="">Todas as lojas</option>
                    <option th:each="store : ${stores}"
                            th:value="${store.id}"
                            th:selected="${selectedStore != null and store.id == selectedStore.id}"
                            th:text="${store.name}"></option>
                  </select>
                </div>
                <div class="col-6 col-lg-2">
                  <label class="form-label" for="filterStart">Data inicial</label>
                  <input id="filterStart" type="date" class="form-control" name="inicio" th:value="${startDate}">
                </div>
                <div class="col-6 col-lg-2">
                  <label class="form-label" for="filterEnd">Data final</label>
                  <input id="filterEnd" type="date" class="form-control" name="fim" th:value="${endDate}">
                </div>
                <div class="col-6 col-lg-2">
                  <label class="form-label" for="filterStatus">Status</label>
                  <select id="filterStatus" name="visitStatus" class="form-select">
                    <option value="">Todos</option>
                    <option th:each="status : ${statusOptions}"
                            th:value="${status.name()}"
                            th:selected="${selectedVisitStatus != null and status.name() == selectedVisitStatus}"
                            th:text="${status.label}"></option>
                  </select>
                </div>
                <div class="col-6 col-lg-3">
                  <label class="form-label" for="filterModality">Modalidade</label>
                  <select id="filterModality" name="modalidade" class="form-select">
                    <option value="">Todas</option>
                    <option th:each="modality : ${modalities}"
                            th:value="${modality.name()}"
                            th:selected="${selectedModality != null and modality.name() == selectedModality}"
                            th:text="${modality.label}"></option>
                  </select>
                </div>
                <div class="col-12 col-lg-3">
                  <label class="form-label" for="filterBuyer">Comprador</label>
                  <select id="filterBuyer" name="buyerId" class="form-select">
                    <option value="">Todos</option>
                    <option th:each="buyer : ${buyers}"
                            th:value="${buyer.id}"
                            th:selected="${selectedBuyerId != null and buyer.id == selectedBuyerId}"
                            th:text="${buyer.name}"></option>
                  </select>
                </div>
                <div class="col-12 col-lg-3">
                  <label class="form-label" for="filterSupplier">Fornecedor</label>
                  <select id="filterSupplier" name="supplierId" class="form-select">
                    <option value="">Todos</option>
                    <option th:each="supplier : ${suppliers}"
                            th:value="${supplier.id}"
                            th:selected="${selectedSupplierId != null and supplier.id == selectedSupplierId}"
                            th:text="${supplier.name}"></option>
                  </select>
                </div>
                <div class="col-12 col-lg-3">
                  <label class="form-label" for="filterSegment">Segmento</label>
                  <select id="filterSegment" name="segmentId" class="form-select">
                    <option value="">Todos</option>
                    <option th:each="segment : ${segments}"
                            th:value="${segment.id}"
                            th:selected="${selectedSegmentId != null and segment.id == selectedSegmentId}"
                            th:text="${segment.name}"></option>
                  </select>
                </div>
                <div class="col-6 col-lg-2">
                  <label class="form-label" for="filterDay">Dia da semana</label>
                  <select id="filterDay" name="dia" class="form-select">
                    <option th:each="option : ${dayOptions}"
                            th:value="${option}"
                            th:selected="${option == selectedDayFilter}"
                            th:text="${option == 'todos' ? 'Todos' : #strings.capitalize(option)}"></option>
                  </select>
                </div>
                <div class="col-6 col-lg-2">
                  <label class="form-label" for="filterSize">Itens por página</label>
                  <select id="filterSize" name="size" class="form-select">
                    <option value="10" th:selected="${pageSize == 10}">10</option>
                    <option value="20" th:selected="${pageSize == 20}">20</option>
                    <option value="50" th:selected="${pageSize == 50}">50</option>
                    <option value="100" th:selected="${pageSize == 100}">100</option>
                  </select>
                </div>
                <div class="col-12 col-lg-2 text-lg-end">
                  <button class="btn btn-success w-100" type="submit">Aplicar filtros</button>
                  <a class="btn btn-link btn-sm d-block mt-2" th:href="@{/admin/visitas}">Limpar</a>
                </div>
              </form>

              <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-2 mb-3">
                <div class="small text-muted">
                  <span th:text="${totalFilteredVisits}">0</span> visita(s) encontradas.
                </div>
                <form method="get" th:action="@{/admin/visitas/exportar}" class="d-flex flex-wrap gap-2 align-items-center">
                  <input type="hidden" name="storeId" th:value="${selectedStore != null ? selectedStore.id : ''}">
                  <input type="hidden" name="inicio" th:value="${startDate}">
                  <input type="hidden" name="fim" th:value="${endDate}">
                  <input type="hidden" name="visitStatus" th:value="${selectedVisitStatus}">
                  <input type="hidden" name="modalidade" th:value="${selectedModality}">
                  <input type="hidden" name="buyerId" th:value="${selectedBuyerId}">
                  <input type="hidden" name="supplierId" th:value="${selectedSupplierId}">
                  <input type="hidden" name="segmentId" th:value="${selectedSegmentId}">
                  <input type="hidden" name="dia" th:value="${selectedDayFilter}">
                  <button type="submit" class="btn btn-outline-success btn-sm">Exportar XLSX</button>
                </form>
              </div>

              <div class="table-responsive">
                <table class="table align-middle mb-0">
                  <thead>
                    <tr>
                      <th>Lojas</th>
                      <th>Data</th>
                      <th>Modalidade</th>
                      <th>Comprador</th>
                      <th>Fornecedor</th>
                      <th>Segmento</th>
                      <th>Status</th>
                      <th>Informações comerciais</th>
                      <th>Observações</th>
                      <th>Atualização status</th>
                      <th class="text-end">Ações</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr th:each="visit : ${visits}">
                      <td>
                        <span class="badge text-bg-light me-1" th:each="store : ${visit.stores}" th:text="${store.name}"></span>
                      </td>
                      <td th:text="${#temporals.format(visit.scheduledDate, 'dd/MM/yyyy')}">10/06/2024</td>
                      <td th:text="${visit.modality != null ? visit.modality.label : '-'}">Promotoria - Reposição</td>
                      <td th:text="${visit.buyer != null ? visit.buyer.name : '-'}">-</td>
                      <td th:text="${visit.supplier != null ? visit.supplier.name : '-'}">-</td>
                      <td th:text="${visit.segment != null ? visit.segment.name : '-'}">-</td>
                      <td>
                        <span class="badge"
                              th:classappend="${visit.status != null} ? ' ' + visit.status.badgeClass : ' text-bg-secondary'"
                              th:text="${visit.status != null ? visit.status.label : '-'}">-</span>
                      </td>
                      <td th:text="${visit.commercialInfo} ?: '-'">-</td>
                      <td th:text="${visit.comment} ?: '-'">-</td>
                      <td>
                        <div class="small" th:text="${visit.lastStatusUpdatedAt != null ? #temporals.format(visit.lastStatusUpdatedAt, 'dd/MM/yyyy HH:mm') : '-'}">-</div>
                        <div class="small text-muted" th:text="${visit.lastStatusUpdatedBy != null ? visit.lastStatusUpdatedBy.name : '-'}">-</div>
                      </td>
                      <td class="text-end">
                        <div class="d-flex flex-wrap justify-content-end gap-2">
                          <a class="btn btn-outline-primary btn-sm"
                             th:href="@{'/admin/visitas/' + ${visit.id} + '/editar'(redirect=${#strings.isEmpty(currentQuery) ? null : #urls.urlEncode(currentQuery)})}">Editar</a>
                          <form th:action="@{'/admin/visitas/' + ${visit.id} + '/excluir'}" method="post" class="d-inline">
                            <input type="hidden" name="redirect" th:value="${currentQuery}">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <button type="submit" class="btn btn-outline-danger btn-sm"
                                    onclick="return confirm('Deseja realmente excluir esta visita?');">Excluir</button>
                          </form>
                        </div>
                      </td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(visits)}">
                    <td colspan="11" class="text-center text-muted py-4">Nenhuma visita encontrada.</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-2 mt-3">
                <form method="get" class="d-inline-flex gap-2">
                  <input type="hidden" name="page" th:value="${currentPage - 1}">
                  <input type="hidden" name="size" th:value="${pageSize}">
                  <input type="hidden" name="storeId" th:value="${selectedStore != null ? selectedStore.id : ''}">
                  <input type="hidden" name="inicio" th:value="${startDate}">
                  <input type="hidden" name="fim" th:value="${endDate}">
                  <input type="hidden" name="visitStatus" th:value="${selectedVisitStatus}">
                  <input type="hidden" name="modalidade" th:value="${selectedModality}">
                  <input type="hidden" name="buyerId" th:value="${selectedBuyerId}">
                  <input type="hidden" name="supplierId" th:value="${selectedSupplierId}">
                  <input type="hidden" name="segmentId" th:value="${selectedSegmentId}">
                  <input type="hidden" name="dia" th:value="${selectedDayFilter}">
                  <button class="btn btn-outline-secondary btn-sm" type="submit" th:disabled="${currentPage == 0}">Anterior</button>
                </form>
                <span class="small text-muted">Página <span th:text="${currentPage + 1}">1</span> de <span th:text="${totalPages == 0 ? 1 : totalPages}">1</span></span>
                <form method="get" class="d-inline-flex gap-2">
                  <input type="hidden" name="page" th:value="${currentPage + 1}">
                  <input type="hidden" name="size" th:value="${pageSize}">
                  <input type="hidden" name="storeId" th:value="${selectedStore != null ? selectedStore.id : ''}">
                  <input type="hidden" name="inicio" th:value="${startDate}">
                  <input type="hidden" name="fim" th:value="${endDate}">
                  <input type="hidden" name="visitStatus" th:value="${selectedVisitStatus}">
                  <input type="hidden" name="modalidade" th:value="${selectedModality}">
                  <input type="hidden" name="buyerId" th:value="${selectedBuyerId}">
                  <input type="hidden" name="supplierId" th:value="${selectedSupplierId}">
                  <input type="hidden" name="segmentId" th:value="${selectedSegmentId}">
                  <input type="hidden" name="dia" th:value="${selectedDayFilter}">
                  <button class="btn btn-outline-secondary btn-sm" type="submit"
                          th:disabled="${totalPages == 0 or currentPage + 1 >= totalPages}">Próxima</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </th:block>
  </th:block>
</html>
