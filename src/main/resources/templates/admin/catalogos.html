<!doctype html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
  <th:block th:replace="~{fragments/layout :: layout(~{::content})}">
    <th:block th:fragment="content">
      <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between mb-3 gap-3">
        <div>
          <h4 class="mb-0">Catálogos auxiliares</h4>
          <p class="text-muted mb-0">Cadastre, edite e importe compradores, fornecedores e segmentos usados no agendamento de visitas.</p>
        </div>
        <a class="btn btn-outline-success btn-sm" href="/admin/visitas">Voltar para agenda</a>
      </div>

      <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>
      <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
      <div th:if="${warningMessages}" class="alert alert-warning">
        <p class="mb-1 fw-semibold">Importação concluída com avisos:</p>
        <ul class="mb-0 ps-3">
          <li th:each="msg : ${warningMessages}" th:text="${msg}"></li>
        </ul>
      </div>

      <div class="row g-4">
        <div class="col-12 col-lg-4">
          <div class="card shadow-sm h-100">
            <div class="card-body d-flex flex-column">
              <h5 class="card-title">Compradores</h5>
              <form th:action="@{/admin/catalogos/compradores}" method="post" class="row g-2 mb-3">
                <div class="col-12">
                  <label class="form-label" for="novoComprador">Nome</label>
                  <input id="novoComprador" class="form-control" name="name" placeholder="Nome do comprador" required>
                </div>
                <div class="col-12">
                  <input type="hidden" name="redirect" th:value="${catalogQuery}">
                  <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                  <button class="btn btn-success w-100" type="submit">Salvar</button>
                </div>
              </form>

              <div class="mb-3">
                <h6 class="fw-semibold">Importar planilha</h6>
                <p class="text-muted small">O arquivo deve conter uma coluna "Nome".</p>
                <div class="d-flex flex-column gap-2 mb-2">
                  <a class="btn btn-outline-secondary btn-sm" href="/modelos/compradores.csv" download>Modelo CSV</a>
                </div>
                <form th:action="@{/admin/catalogos/compradores/importar}" method="post" enctype="multipart/form-data" class="d-flex gap-2">
                  <input class="form-control" type="file" name="file" accept=".csv,.txt" required>
                  <input type="hidden" name="redirect" th:value="${catalogQuery}">
                  <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                  <button class="btn btn-outline-success" type="submit">Importar</button>
                </form>
              </div>

              <form method="get" class="row g-2 align-items-end mb-3">
                <input type="hidden" name="buyerPage" value="0">
                <input type="hidden" name="supplierPage" th:value="${supplierPage.number}">
                <input type="hidden" name="segmentPage" th:value="${segmentPage.number}">
                <input type="hidden" name="supplierSearch" th:value="${supplierSearch} ?: ''">
                <input type="hidden" name="segmentSearch" th:value="${segmentSearch} ?: ''">
                <div class="col-8">
                  <label class="form-label">Buscar comprador</label>
                  <input class="form-control" name="buyerSearch" placeholder="Nome" th:value="${buyerSearch} ?: ''">
                </div>
                <div class="col-4 text-end">
                  <button class="btn btn-outline-success w-100" type="submit">Filtrar</button>
                </div>
              </form>

              <div class="table-responsive small">
                <table class="table table-sm align-middle mb-0">
                  <thead>
                    <tr>
                      <th>Nome</th>
                      <th>Status</th>
                      <th class="text-end">Ações</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr th:each="buyer : ${buyerPage.content}">
                      <td>
                        <form th:action="@{'/admin/catalogos/compradores/' + ${buyer.id}}" method="post" class="input-group input-group-sm">
                          <input class="form-control" name="name" th:value="${buyer.name}" required>
                          <input type="hidden" name="redirect" th:value="${catalogQuery}">
                          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                          <button class="btn btn-outline-success" type="submit">Salvar</button>
                        </form>
                      </td>
                      <td>
                        <form th:action="@{'/admin/catalogos/compradores/' + ${buyer.id} + '/status'}" method="post">
                          <input type="hidden" name="redirect" th:value="${catalogQuery}">
                          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                          <button class="btn btn-sm" type="submit"
                                  th:classappend="${buyer.active} ? ' btn-outline-success' : ' btn-outline-secondary'"
                                  th:text="${buyer.active} ? 'Ativo' : 'Inativo'"></button>
                        </form>
                      </td>
                      <td class="text-end">
                        <form th:action="@{'/admin/catalogos/compradores/' + ${buyer.id} + '/excluir'}" method="post" onsubmit="return confirm('Deseja remover este comprador?');">
                          <input type="hidden" name="redirect" th:value="${catalogQuery}">
                          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                          <button class="btn btn-outline-danger btn-sm" type="submit">Excluir</button>
                        </form>
                      </td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(buyerPage.content)}">
                      <td colspan="3" class="text-center text-muted py-3">Nenhum comprador encontrado.</td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <div class="d-flex justify-content-between align-items-center mt-3">
                <form method="get" class="d-inline">
                  <input type="hidden" name="buyerPage" th:value="${buyerPage.number - 1}">
                  <input type="hidden" name="supplierPage" th:value="${supplierPage.number}">
                  <input type="hidden" name="segmentPage" th:value="${segmentPage.number}">
                  <input type="hidden" name="buyerSearch" th:value="${buyerSearch} ?: ''">
                  <input type="hidden" name="supplierSearch" th:value="${supplierSearch} ?: ''">
                  <input type="hidden" name="segmentSearch" th:value="${segmentSearch} ?: ''">
                  <button class="btn btn-outline-secondary btn-sm" type="submit" th:disabled="${!buyerPage.hasPrevious()}">Anterior</button>
                </form>
                <span class="small text-muted">Página <span th:text="${buyerPage.number + 1}">1</span> de <span th:text="${buyerPage.totalPages == 0 ? 1 : buyerPage.totalPages}">1</span></span>
                <form method="get" class="d-inline">
                  <input type="hidden" name="buyerPage" th:value="${buyerPage.number + 1}">
                  <input type="hidden" name="supplierPage" th:value="${supplierPage.number}">
                  <input type="hidden" name="segmentPage" th:value="${segmentPage.number}">
                  <input type="hidden" name="buyerSearch" th:value="${buyerSearch} ?: ''">
                  <input type="hidden" name="supplierSearch" th:value="${supplierSearch} ?: ''">
                  <input type="hidden" name="segmentSearch" th:value="${segmentSearch} ?: ''">
                  <button class="btn btn-outline-secondary btn-sm" type="submit" th:disabled="${!buyerPage.hasNext()}">Próxima</button>
                </form>
              </div>
            </div>
          </div>
        </div>

        <div class="col-12 col-lg-4">
          <div class="card shadow-sm h-100">
            <div class="card-body d-flex flex-column">
              <h5 class="card-title">Fornecedores</h5>
              <form th:action="@{/admin/catalogos/fornecedores}" method="post" class="row g-2 mb-3">
                <div class="col-12">
                  <label class="form-label" for="novoFornecedor">Nome</label>
                  <input id="novoFornecedor" class="form-control" name="name" placeholder="Nome do fornecedor" required>
                </div>
                <div class="col-12">
                  <input type="hidden" name="redirect" th:value="${catalogQuery}">
                  <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                  <button class="btn btn-success w-100" type="submit">Salvar</button>
                </div>
              </form>

              <div class="mb-3">
                <h6 class="fw-semibold">Importar planilha</h6>
                <p class="text-muted small">O arquivo deve conter uma coluna "Nome".</p>
                <div class="d-flex flex-column gap-2 mb-2">
                  <a class="btn btn-outline-secondary btn-sm" href="/modelos/fornecedores.csv" download>Modelo CSV</a>
                </div>
                <form th:action="@{/admin/catalogos/fornecedores/importar}" method="post" enctype="multipart/form-data" class="d-flex gap-2">
                  <input class="form-control" type="file" name="file" accept=".csv,.txt" required>
                  <input type="hidden" name="redirect" th:value="${catalogQuery}">
                  <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                  <button class="btn btn-outline-success" type="submit">Importar</button>
                </form>
              </div>

              <form method="get" class="row g-2 align-items-end mb-3">
                <input type="hidden" name="supplierPage" value="0">
                <input type="hidden" name="buyerPage" th:value="${buyerPage.number}">
                <input type="hidden" name="segmentPage" th:value="${segmentPage.number}">
                <input type="hidden" name="buyerSearch" th:value="${buyerSearch} ?: ''">
                <input type="hidden" name="segmentSearch" th:value="${segmentSearch} ?: ''">
                <div class="col-8">
                  <label class="form-label">Buscar fornecedor</label>
                  <input class="form-control" name="supplierSearch" placeholder="Nome" th:value="${supplierSearch} ?: ''">
                </div>
                <div class="col-4 text-end">
                  <button class="btn btn-outline-success w-100" type="submit">Filtrar</button>
                </div>
              </form>

              <div class="table-responsive small">
                <table class="table table-sm align-middle mb-0">
                  <thead>
                    <tr>
                      <th>Nome</th>
                      <th>Status</th>
                      <th class="text-end">Ações</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr th:each="supplier : ${supplierPage.content}">
                      <td>
                        <form th:action="@{'/admin/catalogos/fornecedores/' + ${supplier.id}}" method="post" class="input-group input-group-sm">
                          <input class="form-control" name="name" th:value="${supplier.name}" required>
                          <input type="hidden" name="redirect" th:value="${catalogQuery}">
                          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                          <button class="btn btn-outline-success" type="submit">Salvar</button>
                        </form>
                      </td>
                      <td>
                        <form th:action="@{'/admin/catalogos/fornecedores/' + ${supplier.id} + '/status'}" method="post">
                          <input type="hidden" name="redirect" th:value="${catalogQuery}">
                          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                          <button class="btn btn-sm" type="submit"
                                  th:classappend="${supplier.active} ? ' btn-outline-success' : ' btn-outline-secondary'"
                                  th:text="${supplier.active} ? 'Ativo' : 'Inativo'"></button>
                        </form>
                      </td>
                      <td class="text-end">
                        <form th:action="@{'/admin/catalogos/fornecedores/' + ${supplier.id} + '/excluir'}" method="post" onsubmit="return confirm('Deseja remover este fornecedor?');">
                          <input type="hidden" name="redirect" th:value="${catalogQuery}">
                          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                          <button class="btn btn-outline-danger btn-sm" type="submit">Excluir</button>
                        </form>
                      </td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(supplierPage.content)}">
                      <td colspan="3" class="text-center text-muted py-3">Nenhum fornecedor encontrado.</td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <div class="d-flex justify-content-between align-items-center mt-3">
                <form method="get" class="d-inline">
                  <input type="hidden" name="supplierPage" th:value="${supplierPage.number - 1}">
                  <input type="hidden" name="buyerPage" th:value="${buyerPage.number}">
                  <input type="hidden" name="segmentPage" th:value="${segmentPage.number}">
                  <input type="hidden" name="buyerSearch" th:value="${buyerSearch} ?: ''">
                  <input type="hidden" name="supplierSearch" th:value="${supplierSearch} ?: ''">
                  <input type="hidden" name="segmentSearch" th:value="${segmentSearch} ?: ''">
                  <button class="btn btn-outline-secondary btn-sm" type="submit" th:disabled="${!supplierPage.hasPrevious()}">Anterior</button>
                </form>
                <span class="small text-muted">Página <span th:text="${supplierPage.number + 1}">1</span> de <span th:text="${supplierPage.totalPages == 0 ? 1 : supplierPage.totalPages}">1</span></span>
                <form method="get" class="d-inline">
                  <input type="hidden" name="supplierPage" th:value="${supplierPage.number + 1}">
                  <input type="hidden" name="buyerPage" th:value="${buyerPage.number}">
                  <input type="hidden" name="segmentPage" th:value="${segmentPage.number}">
                  <input type="hidden" name="buyerSearch" th:value="${buyerSearch} ?: ''">
                  <input type="hidden" name="supplierSearch" th:value="${supplierSearch} ?: ''">
                  <input type="hidden" name="segmentSearch" th:value="${segmentSearch} ?: ''">
                  <button class="btn btn-outline-secondary btn-sm" type="submit" th:disabled="${!supplierPage.hasNext()}">Próxima</button>
                </form>
              </div>
            </div>
          </div>
        </div>

        <div class="col-12 col-lg-4">
          <div class="card shadow-sm h-100">
            <div class="card-body d-flex flex-column">
              <h5 class="card-title">Segmentos</h5>
              <form th:action="@{/admin/catalogos/segmentos}" method="post" class="row g-2 mb-3">
                <div class="col-12">
                  <label class="form-label" for="novoSegmento">Nome</label>
                  <input id="novoSegmento" class="form-control" name="name" placeholder="Ex.: Horti, Granjeiro" required>
                </div>
                <div class="col-12">
                  <input type="hidden" name="redirect" th:value="${catalogQuery}">
                  <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                  <button class="btn btn-success w-100" type="submit">Salvar</button>
                </div>
              </form>

              <div class="mb-3">
                <h6 class="fw-semibold">Importar planilha</h6>
                <p class="text-muted small">O arquivo deve conter uma coluna "Nome".</p>
                <div class="d-flex flex-column gap-2 mb-2">
                  <a class="btn btn-outline-secondary btn-sm" href="/modelos/segmentos.csv" download>Modelo CSV</a>
                </div>
                <form th:action="@{/admin/catalogos/segmentos/importar}" method="post" enctype="multipart/form-data" class="d-flex gap-2">
                  <input class="form-control" type="file" name="file" accept=".csv,.txt" required>
                  <input type="hidden" name="redirect" th:value="${catalogQuery}">
                  <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                  <button class="btn btn-outline-success" type="submit">Importar</button>
                </form>
              </div>

              <form method="get" class="row g-2 align-items-end mb-3">
                <input type="hidden" name="segmentPage" value="0">
                <input type="hidden" name="buyerPage" th:value="${buyerPage.number}">
                <input type="hidden" name="supplierPage" th:value="${supplierPage.number}">
                <input type="hidden" name="buyerSearch" th:value="${buyerSearch} ?: ''">
                <input type="hidden" name="supplierSearch" th:value="${supplierSearch} ?: ''">
                <div class="col-8">
                  <label class="form-label">Buscar segmento</label>
                  <input class="form-control" name="segmentSearch" placeholder="Nome" th:value="${segmentSearch} ?: ''">
                </div>
                <div class="col-4 text-end">
                  <button class="btn btn-outline-success w-100" type="submit">Filtrar</button>
                </div>
              </form>

              <div class="table-responsive small">
                <table class="table table-sm align-middle mb-0">
                  <thead>
                    <tr>
                      <th>Nome</th>
                      <th>Status</th>
                      <th class="text-end">Ações</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr th:each="segment : ${segmentPage.content}">
                      <td>
                        <form th:action="@{'/admin/catalogos/segmentos/' + ${segment.id}}" method="post" class="input-group input-group-sm">
                          <input class="form-control" name="name" th:value="${segment.name}" required>
                          <input type="hidden" name="redirect" th:value="${catalogQuery}">
                          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                          <button class="btn btn-outline-success" type="submit">Salvar</button>
                        </form>
                      </td>
                      <td>
                        <form th:action="@{'/admin/catalogos/segmentos/' + ${segment.id} + '/status'}" method="post">
                          <input type="hidden" name="redirect" th:value="${catalogQuery}">
                          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                          <button class="btn btn-sm" type="submit"
                                  th:classappend="${segment.active} ? ' btn-outline-success' : ' btn-outline-secondary'"
                                  th:text="${segment.active} ? 'Ativo' : 'Inativo'"></button>
                        </form>
                      </td>
                      <td class="text-end">
                        <form th:action="@{'/admin/catalogos/segmentos/' + ${segment.id} + '/excluir'}" method="post" onsubmit="return confirm('Deseja remover este segmento?');">
                          <input type="hidden" name="redirect" th:value="${catalogQuery}">
                          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                          <button class="btn btn-outline-danger btn-sm" type="submit">Excluir</button>
                        </form>
                      </td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(segmentPage.content)}">
                      <td colspan="3" class="text-center text-muted py-3">Nenhum segmento encontrado.</td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <div class="d-flex justify-content-between align-items-center mt-3">
                <form method="get" class="d-inline">
                  <input type="hidden" name="segmentPage" th:value="${segmentPage.number - 1}">
                  <input type="hidden" name="buyerPage" th:value="${buyerPage.number}">
                  <input type="hidden" name="supplierPage" th:value="${supplierPage.number}">
                  <input type="hidden" name="buyerSearch" th:value="${buyerSearch} ?: ''">
                  <input type="hidden" name="supplierSearch" th:value="${supplierSearch} ?: ''">
                  <input type="hidden" name="segmentSearch" th:value="${segmentSearch} ?: ''">
                  <button class="btn btn-outline-secondary btn-sm" type="submit" th:disabled="${!segmentPage.hasPrevious()}">Anterior</button>
                </form>
                <span class="small text-muted">Página <span th:text="${segmentPage.number + 1}">1</span> de <span th:text="${segmentPage.totalPages == 0 ? 1 : segmentPage.totalPages}">1</span></span>
                <form method="get" class="d-inline">
                  <input type="hidden" name="segmentPage" th:value="${segmentPage.number + 1}">
                  <input type="hidden" name="buyerPage" th:value="${buyerPage.number}">
                  <input type="hidden" name="supplierPage" th:value="${supplierPage.number}">
                  <input type="hidden" name="buyerSearch" th:value="${buyerSearch} ?: ''">
                  <input type="hidden" name="supplierSearch" th:value="${supplierSearch} ?: ''">
                  <input type="hidden" name="segmentSearch" th:value="${segmentSearch} ?: ''">
                  <button class="btn btn-outline-secondary btn-sm" type="submit" th:disabled="${!segmentPage.hasNext()}">Próxima</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </th:block>
  </th:block>
</html>
